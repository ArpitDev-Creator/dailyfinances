<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Finances</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Note: Removed Firebase SDKs as requested to use localStorage -->

<style>
  :root{
    --primary:#0b5ed7; /* deep blue */
    --accent:#3b82f6;
    --bg-light:#f7fafc;
    --bg-dark:#0f1724;
    --card-light:#ffffff;
    --card-dark:#0b1220;
    --text-light:#0b1224;
    --text-dark:#e6eef8;
    --muted:#6b7280;
    --success:#10b981;
    --danger:#ef4444;
    --radius:12px;
  }
  [data-theme="dark"]{
    --bg:var(--bg-dark);
    --card:var(--card-dark);
    --text:var(--text-dark);
  }
  [data-theme="light"]{
    --bg:var(--bg-light);
    --card:var(--card-light);
    --text:var(--text-light);
  }

  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);transition:background .25s,color .25s;}
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:#fff; padding:14px 18px; display:flex; align-items:center; gap:12px; box-shadow:0 6px 18px rgba(11,78,203,0.12);
    border-bottom-left-radius:0; border-bottom-right-radius:0;
  }
  .logo{
    display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.05rem;
    max-width: 70%;
  }
  .logo svg{width:36px;height:36px;flex:0 0 36px;border-radius:8px;background:rgba(255,255,255,0.08); padding:4px;}
  .logo .app-title-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  .container{max-width:1100px;margin:18px auto;padding:0 14px 80px;}
  .top-actions{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap;}
  .theme-toggle{background:var(--card);border:none;padding:8px 10px;border-radius:999px;cursor:pointer;box-shadow:0 3px 10px rgba(2,6,23,0.06);}
  form{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 4px 18px rgba(2,6,23,0.06);margin-bottom:16px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px;}
  @media(max-width:880px){ .grid{grid-template-columns:1fr;} .top-actions{gap:8px;}}
  .form-row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  @media(max-width:520px){ .form-row{grid-template-columns:1fr;} }
  input[type="text"], input[type="number"], input[type="date"], select, button{
    padding:10px 12px; font-size:0.95rem; border-radius:8px; border:1px solid rgba(15,23,42,0.06); width:100%;
    background:transparent; color:inherit;
  }
  button.primary{background:var(--primary); color:#fff; border:none; cursor:pointer;}
  button.ghost{background:transparent; border:1px solid rgba(15,23,42,0.06);}
  .flex{display:flex; gap:8px; align-items:center;}
  .flex button{padding:10px 12px;}
  .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 4px 12px rgba(2,6,23,0.04);}
  .summary{display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;}
  .summary .stat{flex:1; text-align:left; padding:12px;}
  .stat h3{margin:0;font-size:0.9rem;color:var(--muted);}
  .stat p{margin:6px 0 0;font-weight:700;font-size:1.15rem;}
  /* Expenses table */
  .table-wrap{overflow:auto;border-radius:10px;}
  table{width:100%;border-collapse:collapse;min-width:760px;}
  th, td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(2,6,23,0.06);}
  th{background:var(--primary); color:#fff; position:relative; font-weight:700;}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-size:0.8rem;}
  .badge.income{background:rgba(16,185,129,0.12); color:var(--success); border:1px solid rgba(16,185,129,0.18);}
  .badge.expense{background:rgba(239,68,68,0.08); color:var(--danger); border:1px solid rgba(239,68,68,0.12);}
  .actions button{margin-right:8px;padding:6px 8px;border-radius:6px;border:1px solid rgba(2,6,23,0.06);cursor:pointer;background:transparent;}
  .muted{color:var(--muted);font-size:0.9rem;}
  footer{margin-top:20px;padding:14px;text-align:center;color:var(--muted);}

  /* small UI tweaks */
  .small{font-size:0.85rem;}
  .charts{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  @media(max-width:760px){ .charts{grid-template-columns:1fr;} }

  /* Custom Message Box (replacing alert/confirm) */
  #modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6); z-index: 1000;
    display: none; /* Hidden by default */
    align-items: center; justify-content: center;
  }
  #confirm-modal {
    background: var(--card); color: var(--text); padding: 20px;
    border-radius: var(--radius); width: 90%; max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  #confirm-modal h4 { margin-top: 0; }
  #modal-buttons {
    display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;
  }
  #modal-buttons button { width: auto; padding: 8px 15px; }
  #modal-buttons .confirm { background: var(--danger); color: white; border: none; }
</style>
</head>
<body data-theme="light">

<!-- Custom Confirmation Modal/Message Box -->
<div id="modal-overlay">
  <div id="confirm-modal">
    <h4 id="modal-title">Confirm Action</h4>
    <p id="modal-message">Are you sure you want to proceed?</p>
    <div id="modal-buttons">
      <button id="modal-cancel" class="ghost">Cancel</button>
      <button id="modal-confirm" class="confirm">Confirm</button>
    </div>
  </div>
</div>

<header>
  <div class="logo" aria-hidden="true">
    <!-- Simple SVG logo matching Daily Finances theme -->
    <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="logo">
      <rect x="2" y="2" width="44" height="44" rx="10" fill="white" opacity="0.06"/>
      <path d="M14 32c3-4 9-6 14-6" stroke="white" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14 24c3-4 9-6 14-6" stroke="#CDE4FF" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="36" cy="14" r="6" fill="#fff" opacity="0.12"/>
      <path d="M33.5 15.5L38.5 12.5" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <span class="app-title-text" title="Daily Finances">Daily Finances</span>
  </div>

  <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
    <button class="theme-toggle" id="theme-btn" title="Toggle theme">ðŸŒ“</button>
  </div>
</header>

<div class="container">

  <div class="top-actions">
    <div class="muted small">
      Manage your daily finances â€” add income & expense quickly.
    </div>
    <div class="flex">
      <button id="export-csv" class="ghost small">Export CSV</button>
      <button id="clear-all" class="ghost small">Clear All</button>
    </div>
  </div>

  <div class="grid">
    <!-- Form -->
    <form id="tx-form" class="card" autocomplete="off">
      <h3 style="margin-top:0;">Add Transaction</h3>
      <div class="form-row">
        <select id="tx-type" required>
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
        <input id="amount" type="number" placeholder="Amount (â‚¹)" step="0.01" required />
      </div>

      <div class="form-row" style="margin-top:8px;">
        <select id="category" required>
          <!-- populated by JS -->
        </select>
        <input id="description" type="text" placeholder="Description (optional)" />
      </div>

      <div class="form-row" style="margin-top:8px;">
        <input id="date" type="date" required />
        <select id="recurring">
          <option value="None">Recurring? None</option>
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
          <option value="Monthly">Monthly</option>
        </select>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button type="submit" class="primary">Save Transaction</button>
        <button type="button" id="cancel-edit" class="ghost">Cancel Edit</button>
      </div>
    </form>

    <!-- Category add + summary cards -->
    <div>
      <form id="category-form" class="card small">
        <h3 style="margin:0 0 8px 0;">Add Category</h3>
        <div style="display:flex; gap:8px;">
          <input id="new-category" type="text" placeholder="New category name" />
          <button type="submit" class="primary">Add</button>
        </div>
      </form>

      <div class="summary" style="margin-top:12px;">
        <div class="card stat">
          <h3>Total Income</h3>
          <p id="total-income">â‚¹0.00</p>
        </div>
        <div class="card stat">
          <h3>Total Expense</h3>
          <p id="total-expense">â‚¹0.00</p>
        </div>
        <div class="card stat">
          <h3>Balance</h3>
          <p id="balance">â‚¹0.00</p>
        </div>
        <div class="card stat">
          <h3>Top Category</h3>
          <p id="top-category">-</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and table -->
  <div class="card" style="margin-top:8px;">
    <h3 style="margin-top:0;">Transactions History</h3>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <input id="search" type="text" placeholder="Search description" style="min-width:180px;" />
      <select id="filter-type">
        <option value="">All Types</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
      <select id="filter-category">
        <option value="">All Categories</option>
      </select>
      <input id="from" type="date" title="Filter from date" />
      <input id="to" type="date" title="Filter to date" />
      <button id="apply-filter" class="ghost">Apply</button>
      <button id="reset-filter" class="ghost">Reset</button>
    </div>

    <div class="table-wrap card" style="padding:0;">
      <table id="tx-table" role="grid" aria-label="Transactions table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Amount (â‚¹)</th>
            <th>Category</th>
            <th>Description</th>
            <th>Date</th>
            <th>Recurring</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts" style="margin-top:14px;">
    <div class="card">
      <h3 style="margin-top:0;">Expense by Category</h3>
      <canvas id="expense-chart"></canvas>
    </div>
    <div class="card">
      <h3 style="margin-top:0;">Income by Category</h3>
      <canvas id="income-chart"></canvas>
    </div>
  </div>

  <footer>
    Created by Arpit Dev - Daily Finances
  </footer>
</div>

<script>
  // --- Custom Modal Logic to replace window.confirm/alert ---
  let currentConfirmAction = null;
  const modalOverlay = document.getElementById('modal-overlay');
  const modalMessage = document.getElementById('modal-message');
  const modalTitle = document.getElementById('modal-title');
  const modalConfirmBtn = document.getElementById('modal-confirm');
  const modalCancelBtn = document.getElementById('modal-cancel');

  function showConfirm(title, message, onConfirmCallback) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    currentConfirmAction = onConfirmCallback;
    modalOverlay.style.display = 'flex';
  }

  modalConfirmBtn.addEventListener('click', () => {
    if (currentConfirmAction) {
      currentConfirmAction();
    }
    modalOverlay.style.display = 'none';
    currentConfirmAction = null;
  });

  modalCancelBtn.addEventListener('click', () => {
    modalOverlay.style.display = 'none';
    currentConfirmAction = null;
  });
  // --- End Custom Modal Logic ---

/* ===== Storage & initial data (Using localStorage for fast access) ===== */
let txns = JSON.parse(localStorage.getItem('txns')) || [];
let categories = JSON.parse(localStorage.getItem('categories')) || ["Salary","Food","Travel","Shopping","Bills","Other"];

/* ===== Elements ===== */
const txForm = document.getElementById('tx-form');
const txType = document.getElementById('tx-type');
const amountInput = document.getElementById('amount');
const categorySelect = document.getElementById('category');
const descriptionInput = document.getElementById('description');
const dateInput = document.getElementById('date');
const recurringSelect = document.getElementById('recurring');
const categoryForm = document.getElementById('category-form');
const newCategoryInput = document.getElementById('new-category');
const txTableBody = document.querySelector('#tx-table tbody');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const balanceEl = document.getElementById('balance');
const topCategoryEl = document.getElementById('top-category');
const filterCategory = document.getElementById('filter-category');
const searchInput = document.getElementById('search');
const filterType = document.getElementById('filter-type');
const fromInput = document.getElementById('from');
const toInput = document.getElementById('to');
const applyFilterBtn = document.getElementById('apply-filter');
const resetFilterBtn = document.getElementById('reset-filter');
const exportCSVBtn = document.getElementById('export-csv');
const clearAllBtn = document.getElementById('clear-all');
const cancelEditBtn = document.getElementById('cancel-edit');
const themeBtn = document.getElementById('theme-btn');

let editingId = null;
let expenseChart = null, incomeChart = null;

/* ===== Init ===== */
function init(){
  updateCategoryOptions();
  renderTable();
  updateSummary();
  renderCharts();
  // set default date to today
  dateInput.value = new Date().toISOString().slice(0,10);
  cancelEditBtn.style.display = 'none'; // Ensure cancel button is hidden initially
}
init();

/* ===== Theme Toggle ===== */
themeBtn.addEventListener('click', ()=>{
  document.body.dataset.theme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
});

/* ===== Category options (UI Update) ===== */
function updateCategoryOptions(){
  categorySelect.innerHTML = '<option value="">Select Category</option>';
  filterCategory.innerHTML = '<option value="">All Categories</option>';
  categories.forEach(c=>{
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; categorySelect.appendChild(opt);
    const opt2 = document.createElement('option'); opt2.value = c; opt2.textContent = c; filterCategory.appendChild(opt2);
  });
}

/* ===== Save (Local Storage) ===== */
function save(){
  localStorage.setItem('txns', JSON.stringify(txns));
  localStorage.setItem('categories', JSON.stringify(categories));
}

/* ===== Add / Edit transaction ===== */
txForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const tx = {
    id: editingId || Date.now(),
    type: txType.value, // 'income' or 'expense'
    amount: parseFloat(amountInput.value) || 0,
    category: categorySelect.value || 'Other',
    description: descriptionInput.value || '',
    date: dateInput.value,
    recurring: recurringSelect.value || 'None'
  };
  if(editingId){
    txns = txns.map(t => t.id === editingId ? tx : t);
    editingId = null;
  } else {
    txns.unshift(tx); // Add new transaction to the start
  }
  save();
  txForm.reset();
  dateInput.value = new Date().toISOString().slice(0,10);
  cancelEditBtn.style.display = 'none'; // Hide cancel button after saving
  renderTable();
  updateSummary();
  renderCharts();
});

/* Cancel edit */
cancelEditBtn.addEventListener('click', ()=>{
  editingId = null;
  txForm.reset();
  dateInput.value = new Date().toISOString().slice(0,10);
  cancelEditBtn.style.display = 'none'; // Hide cancel button after reset
});

/* ===== Add category ===== */
categoryForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const val = newCategoryInput.value.trim();
  if(val && !categories.includes(val)){
    categories.push(val);
    save();
    updateCategoryOptions();
    newCategoryInput.value = '';
  }
});

/* ===== Render Table with filters ===== */
function renderTable(){
  const search = searchInput.value.trim().toLowerCase();
  const fType = filterType.value;
  const fCat = filterCategory.value;
  const from = fromInput.value;
  const to = toInput.value;

  let filtered = txns.filter(t=>{
    if(fType && t.type !== fType) return false;
    if(fCat && t.category !== fCat) return false;
    if(search && !t.description.toLowerCase().includes(search) && !t.category.toLowerCase().includes(search)) return false;
    if(from && t.date < from) return false;
    if(to && t.date > to) return false;
    return true;
  });

  // sort by date desc
  filtered.sort((a,b)=> b.date.localeCompare(a.date) || b.id - a.id);

  txTableBody.innerHTML = '';
  if (filtered.length === 0) {
      txTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">No transactions found.</td></tr>`;
      return;
  }

  filtered.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="badge ${t.type}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</span></td>
      <td>â‚¹${t.amount.toFixed(2)}</td>
      <td>${t.category}</td>
      <td class="muted small">${t.description || '-'}</td>
      <td>${t.date}</td>
      <td>${t.recurring}</td>
      <td class="actions">
        <button class="small" data-id="${t.id}" onclick="window.onEdit(${t.id})">Edit</button>
        <button class="small" data-id="${t.id}" onclick="window.onDelete(${t.id})">Delete</button>
      </td>
    `;
    txTableBody.appendChild(tr);
  });
}

/* Edit action - global function for inline onclick */
window.onEdit = function(id){
  const t = txns.find(x=>x.id===id);
  if(!t) return;
  editingId = t.id;
  txType.value = t.type;
  amountInput.value = t.amount;
  categorySelect.value = t.category;
  descriptionInput.value = t.description;
  dateInput.value = t.date;
  recurringSelect.value = t.recurring;
  window.scrollTo({top:0, behavior:'smooth'});
  cancelEditBtn.style.display = 'inline-block'; // Show cancel button when editing
};

/* Delete action - uses custom modal */
window.onDelete = function(id){
  const t = txns.find(x=>x.id===id);
  if(!t) return;

  showConfirm(
    'Confirm Deletion',
    `Are you sure you want to delete the transaction: ${t.category} (â‚¹${t.amount.toFixed(2)})?`,
    ()=>{
      txns = txns.filter(txn=>txn.id!==id);
      save();
      renderTable();
      updateSummary();
      renderCharts();
    }
  );
};

/* ===== Summary (Local Calculation from State) ===== */
function updateSummary(){
  const totalIncome = txns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const totalExpense = txns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const balance = totalIncome - totalExpense;

  totalIncomeEl.textContent = `â‚¹${totalIncome.toFixed(2)}`;
  totalExpenseEl.textContent = `â‚¹${totalExpense.toFixed(2)}`;
  balanceEl.textContent = `â‚¹${balance.toFixed(2)}`;

  // Top category by expense
  const catMap = {};
  txns.filter(t=>t.type==='expense').forEach(t=>{
    catMap[t.category] = (catMap[t.category]||0) + t.amount;
  });
  const top = Object.entries(catMap).sort((a,b)=>b[1]-a[1])[0];
  topCategoryEl.textContent = top ? `${top[0]} (â‚¹${top[1].toFixed(2)})` : '-';
}

/* ===== Charts (Local Render from State) ===== */
function renderCharts(){
  const expenseData = {};
  const incomeData = {};
  txns.forEach(t=>{
    if(t.type==='expense') expenseData[t.category] = (expenseData[t.category]||0) + t.amount;
    else incomeData[t.category] = (incomeData[t.category]||0) + t.amount;
  });
  const eLabels = Object.keys(expenseData);
  const eValues = Object.values(expenseData);
  const iLabels = Object.keys(incomeData);
  const iValues = Object.values(incomeData);

  // destroy old charts
  if(expenseChart) expenseChart.destroy();
  if(incomeChart) incomeChart.destroy();

  const eCtx = document.getElementById('expense-chart').getContext('2d');
  expenseChart = new Chart(eCtx, {
    type: 'doughnut',
    data: {
      labels: eLabels,
      datasets: [{ data: eValues, backgroundColor: eLabels.map((_,i)=>`hsl(${(i*50)%360} 70% 50%)`)}]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom'}} }
  });

  const iCtx = document.getElementById('income-chart').getContext('2d');
  incomeChart = new Chart(iCtx, {
    type: 'doughnut',
    data: {
      labels: iLabels,
      datasets: [{ data: iValues, backgroundColor: iLabels.map((_,i)=>`hsl(${(i*70)%360} 65% 45%)`)}]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* ===== Filters ===== */
applyFilterBtn.addEventListener('click', ()=>{
  renderTable();
});
resetFilterBtn.addEventListener('click', ()=>{
  searchInput.value=''; filterType.value=''; filterCategory.value=''; fromInput.value=''; toInput.value='';
  renderTable();
});

/* ===== Export CSV ===== */
exportCSVBtn.addEventListener('click', ()=>{
  let csv = 'Type,Amount,Category,Description,Date,Recurring\n';
  txns.forEach(t=>{
    // escape quotes in description/category
    const desc = (t.description||'').replace(/"/g,'""');
    csv += `${t.type},${t.amount},${t.category},"${desc}",${t.date},${t.recurring}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'daily_finances_export.csv'; a.click();
});

/* ===== Clear all (Uses Custom Modal) ===== */
clearAllBtn.addEventListener('click', ()=>{
  showConfirm(
    'Confirm Clear All',
    'Are you sure? This will clear all transactions and restore default categories.',
    ()=>{
      txns = [];
      categories = ["Salary","Food","Travel","Shopping","Bills","Other"];
      save();
      updateCategoryOptions();
      renderTable();
      updateSummary();
      renderCharts();
    }
  );
});

/* ===== UI Helpers ===== */
// Show cancel button only when editing a transaction
txForm.addEventListener('change', ()=> {
  if (editingId) cancelEditBtn.style.display = 'inline-block';
});
txForm.addEventListener('input', ()=> {
  if (editingId) cancelEditBtn.style.display = 'inline-block';
});

/* set focus improvements */
amountInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); descriptionInput.focus(); }
});

/* keep saving when user navigates away (good practice for local storage) */
window.addEventListener('beforeunload', save);
</script>

</body>
</html>

